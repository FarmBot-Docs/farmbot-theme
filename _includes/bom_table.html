{%- assign bom_category = page.path | remove: ".md" -%}

<table>
  {% comment %}<!-- Header -->{% endcomment %}
  <thead>
    <th class="part"><i></i></th>
    <th class="notes internal"><i></i></th>
    <th><i></i></th>
    <th class="farmbot-model" colspan="2">
      {{ site.title | remove: "FarmBot " | remove: " Documentation" | default: "Genesis" }}
    </th>
    <th class="farmbot-model" colspan="2">
      {{ site.title | remove: "FarmBot " | remove: " Documentation" | default: "Genesis" }}
      <span class="fb-xl-sticker">XL</span>
    </th>
  </thead>
  <thead>
    <th class="part">Part</th>
    <th class="notes internal">Notes</th>
    <th class="price">Price</th>
    <th class="cost internal">Cost</th>
    <th class="qty">Qty</th>
    <th class="price-subtotal">Subtotal</th>
    <th class="cost-subtotal internal">Subtotal</th>
    <th class="qty">Qty</th>
    <th class="price-subtotal">Subtotal</th>
    <th class="cost-subtotal internal">Subtotal</th>
  </thead>

  {% comment %}<!-- Part rows -->{% endcomment %}
  <tbody>
  {% assign total_quantity = 0 %}
  {% assign total_xl_quantity = 0 %}
  {% assign total_price = 0 %}
  {% assign total_xl_price = 0 %}
  {% assign total_cost = 0 %}
  {% assign total_xl_cost = 0 %}
  {% for part in site.pages %}
    {%- if part.dir contains bom_category and part.specs -%}
      {% comment %}<!-- Parts with variants -->{% endcomment %}
      {%- if part.variants -%}
        {% assign variants = part.variants | split: "|" %}
        {% assign notes = part.internal-specs.notes | split: "|" %}
        {% assign prices = part.price | split: "|" %}
        {% assign costs = part.internal-specs.cost | split: "|" %}
        {% assign genesis_quantities = part.quantity.genesis | split: "|" %}
        {% assign xl_quantities = part.quantity.xl | split: "|" %}
          {%- for variant in variants -%}
          {% if part.internal-specs.notes contains "|" %}
            {% assign note = notes[forloop.index0] %}
          {% else %}
            {% assign note = part.internal-specs.notes %}
          {% endif %}
          {% assign price = prices[forloop.index0] %}
          {% assign cost = costs[forloop.index0] %}
          {% assign genesis_quantity = genesis_quantities[forloop.index0] %}
          {% assign xl_quantity = xl_quantities[forloop.index0] %}
          <tr>
            <td class="part">
              <a href="{{ part.url | remove: '.html' }}#">{{ part.title }} - {{ variant }}</a>
            </td>
            <td class="notes internal">{{ note | default: "---" }}</td>
            <td class="price">{{ price }}</td>
            <td class="cost internal">{{ cost }}</td>
            <td class="qty" qty="{{ genesis_quantity }}">
              <span>{{- genesis_quantity -}}</span>
            </td>
            {%- assign price_subtotal = price | remove: "$" | times: genesis_quantity -%}
            <td class="price-subtotal">{% include format_price.html price=price_subtotal %}</td>
            {% assign cost_subtotal = cost | remove: "$" | times: genesis_quantity %}
            <td class="cost-subtotal internal">{% include format_price.html price=cost_subtotal %}</td>
            <td class="qty" qty="{{ xl_quantity }}">
              <span>{{- xl_quantity -}}</span>
            </td>
            {%- assign xl_price_subtotal = price | remove: "$" | times: xl_quantity -%}
            <td class="price-subtotal">{% include format_price.html price=xl_price_subtotal %}</td>
            {% assign xl_cost_subtotal = cost | remove: "$" | times: xl_quantity %}
            <td class="cost-subtotal internal">{% include format_price.html price=xl_cost_subtotal %}</td>
          </tr>
          {% comment %}<!-- Add variant to TOTAL -->{% endcomment %}
          {% assign total_quantity = total_quantity | plus: genesis_quantity %}
          {% assign total_xl_quantity = total_xl_quantity | plus: xl_quantity %}
          {% assign total_price = total_price | plus: price_subtotal %}
          {% assign total_xl_price = total_xl_price | plus: xl_price_subtotal %}
          {% assign total_cost = total_cost | plus: cost_subtotal %}
          {% assign total_xl_cost = total_xl_cost | plus: xl_cost_subtotal %}
        {%- endfor -%}

      {% comment %}<!-- Parts without variants -->{% endcomment %}
      {%- else -%}
      <tr>
        <td class="part">
          <a href="{{ part.url | remove: '.html' }}#">{{ part.title }}</a>
        </td>
        <td class="notes internal">{{ part.internal-specs.notes | default: "---" }}</td>
        <td class="price">{{ part.price }}</td>
        <td class="cost internal">{{ part.internal-specs.cost }}</td>
        <td class="qty" qty="{{ part.quantity.genesis }}">
          <span>{{ part.quantity.genesis }}</span>
        </td>
        {% assign price_subtotal = part.price | remove: "$" | times: part.quantity.genesis %}
        <td class="price-subtotal">{% include format_price.html price=price_subtotal %}</td>
        {% assign cost_subtotal = part.internal-specs.cost | remove: "$" | times: part.quantity.genesis %}
        <td class="cost-subtotal internal">{% include format_price.html price=cost_subtotal %}</td>
        <td class="qty" qty="{{ part.quantity.xl }}">
          <span>{{ part.quantity.xl }}</span>
        </td>
        {% assign xl_price_subtotal = part.price | remove: "$" | times: part.quantity.xl %}
        <td class="price-subtotal">{% include format_price.html price=xl_price_subtotal %}</td>
        {% assign xl_cost_subtotal = part.internal-specs.cost | remove: "$" | times: part.quantity.xl %}
        <td class="cost-subtotal internal">{% include format_price.html price=xl_cost_subtotal %}</td>
      </tr>
      {% comment %}<!-- Add part to TOTAL -->{% endcomment %}
      {% assign total_quantity = total_quantity | plus: part.quantity.genesis %}
      {% assign total_xl_quantity = total_xl_quantity | plus: part.quantity.xl %}
      {% assign total_price = total_price | plus: price_subtotal %}
      {% assign total_xl_price = total_xl_price | plus: xl_price_subtotal %}
      {% assign total_cost = total_cost | plus: cost_subtotal %}
      {% assign total_xl_cost = total_xl_cost | plus: xl_cost_subtotal %}
      {%- endif -%}
    {% endif %}
  {% endfor %}
  </tbody>

  {% comment %}<!-- Footer -->{% endcomment %}
  <tfoot>
    <td>TOTAL</td>
    <td class="notes internal"><i></i></td>
    <td><i></i></td>
    <td class="qty">{{ total_quantity }}</td>
    <td class="price">{% include format_price.html price=total_price %}</td>
    <td class="cost internal">{% include format_price.html price=total_cost %}</td>
    <td class="qty">{{ total_xl_quantity }}</td>
    <td class="price">{% include format_price.html price=total_xl_price %}</td>
    <td class="cost internal">{% include format_price.html price=total_xl_cost %}</td>
  </tfoot>
</table>