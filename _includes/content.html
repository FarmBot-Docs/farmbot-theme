{%- assign all_headers_joined = '' -%}

{%- for i in (1..3) -%}
{%- capture header_start -%}<h{{ i }} id="{%- endcapture -%}
{%- assign headers_plus = include.content | split: header_start | slice: 1, 999 -%}
{%- capture headers_joined -%}
{%- for header_plus in headers_plus -%}
{%- assign id = header_plus | split: '">' | first -%}
{{ header_start }}{{ id }}">|{{ header_start }}{{ id }}">
<a href="#{{ id }}"><i class="fa fa-anchor"></i></a>%%%
{%- endfor -%}
{%- endcapture -%}
{%- capture all_headers_joined -%}
{{ all_headers_joined }}%%%{{ headers_joined }}
{%- endcapture -%}
{%- endfor -%}

{%- assign content = include.content -%}

{%- assign headers = all_headers_joined | split: '%%%' -%}
{%- for header in headers -%}
{%- assign old = header | split: '|' | first -%}
{%- assign new = header | split: '|' | last -%}
{%- assign content = content | replace: old, new -%}
{%- endfor -%}

{%- assign imgs = include.content | split: '<img src=' | slice: 1, 999 -%}
{%- for img in imgs -%}
{%- assign img_content = img | split: '>' | first -%}
{%- capture img_inner -%}<img src={{ img_content }}>{%- endcapture -%}
{%- capture wrapped_img -%}
<div class='gallery'>
  <img class="gallery-featured-image" src={{ img_content }}>
</div>
{%- endcapture -%}
{%- assign content = content | replace: img_inner, wrapped_img -%}
{%- endfor -%}

{%- assign alt_texts = include.content | split: 'alt="' | slice: 1, 999 -%}
{%- for alt_text in alt_texts -%}
{%- assign alt_text_content = alt_text | split: '"' | first -%}
{%- capture old -%}alt="{{ alt_text_content }}"{%- endcapture -%}
{%- capture new -%}
alt="{{ alt_text_content }}" title="{{ alt_text_content }}"
{%- endcapture -%}
{%- assign content = content | replace: old, new -%}
{%- endfor -%}

{%- assign whats_next_section = content | split: 'What’s next?</h1>'
  | slice: 1 | first -%}
{%- assign new_whats_next_section = whats_next_section -%}
{%- assign whats_next_urls_plus = whats_next_section
  | split: '<a href="' | slice: 1, 999 -%}
{%- for whats_next_url_plus in whats_next_urls_plus -%}
{%- assign url_plus = whats_next_url_plus | split: '</a>' | first -%}
{%- assign url = url_plus | split: '"' | first -%}
{%- assign name = url_plus | split: '>' | last -%}
{%- assign whats_next_page = site.pages | where: 'url', url | first -%}
{%- capture old -%}<a href="{{ url }}">{{ name }}{%- endcapture -%}
{%- assign description = whats_next_page.description
  | newline_to_br | split: '<br />' | first
  | markdownify | strip_html | strip -%}
{%- assign first_char = whats_next_page.description | slice: 0 -%}
{%- if first_char == '[' -%}
{%- assign description = '' -%}
{%- endif -%}
{%- capture new -%}{{ old }}<p>{{ description }}</p>{%- endcapture -%}
{%- assign new_whats_next_section = new_whats_next_section | replace: old, new -%}
{%- endfor -%}

{{
content
  | replace: '<th> </th>', '<th></th>'
  | replace: whats_next_section, new_whats_next_section
}}
